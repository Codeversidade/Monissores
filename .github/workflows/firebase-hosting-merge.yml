# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: E2E Test + Deploy to Firebase Hosting
'on':
  push:
    branches:
      - main
jobs:
  build_and_preview:
    runs-on: ubuntu-latest

    outputs:
      details_url: ${{ steps.deploy_firebase_hosting_channel.outputs.details_url}}

    steps:
      - uses: actions/checkout@v2
      - name: Deploy to Firebase Hosting Channel
        id: deploy_firebase_hosting_channel
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MONISSORES }}'
          channelId: test
          projectId: monissores
      - run: echo ${{steps.deploy_firebase_hosting_channel.outputs.details_url}}

  cypress-run:
    name: Cypress run
    runs-on: ubuntu-22.04
    needs: build_and_preview
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cypress run
        uses: cypress-io/github-action@v5
        with:
          browser: chrome
          config: pageLoadTimeout=100000,baseUrl=${{needs.build_and_preview.outputs.details_url}}
      - run: echo Cypress E2E Tests are done

      # after the test run completes
      # store videos and any screenshots
      # NOTE: screenshots will be generated only if E2E test failed
      # thus we store screenshots only on failures
      # Alternative: create and commit an empty cypress/screenshots folder
      # to always have something to upload
      - uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
      # Test run video was always captured, so this action uses "always()" condition
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos

  build_and_deploy:
    runs-on: ubuntu-latest
    needs: cypress-run
    steps:
      - uses: actions/checkout@v2
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_MONISSORES }}'
          channelId: live
          projectId: monissores
